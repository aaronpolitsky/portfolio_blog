<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Aaron Politsky">
<meta name="dcterms.date" content="2024-02-11">
<meta name="description" content="Tidyverse R enthusiasts know about nesting grouped data into a column and iterating using purrr::map(), but did you know you could nest function source code? This post uses a data validation example to explain how I used this nest-and-iterate pattern over a set of validation tests while keeping the tests, their code, and their results in one Tidy tibble.">

<title>Purrr for Data Validation – Aaron’s Coding and Data Science Blog</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/cookie-consent/cookie-consent.js"></script>
<link href="../../site_libs/cookie-consent/cookie-consent.css" rel="stylesheet">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-D0DVM5VY0B"></script>

<script type="text/plain" cookie-consent="tracking">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-D0DVM5VY0B', { 'anonymize_ip': true});
</script>

<script type="text/javascript" charset="UTF-8">
document.addEventListener('DOMContentLoaded', function () {
cookieconsent.run({
  "notice_banner_type":"simple",
  "consent_type":"implied",
  "palette":"light",
  "language":"en",
  "page_load_consent_levels":["strictly-necessary","functionality","tracking","targeting"],
  "notice_banner_reject_button_hide":false,
  "preferences_center_close_button_hide":false,
  "website_name":""
  ,
"language":"en"
  });
});
</script> 
  


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Aaron’s Coding and Data Science Blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/aaronpolitsky"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/aaronpolitsky"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Purrr for Data Validation</h1>
            <p class="subtitle lead">Or: Nesting Functions Into a Tibble</p>
                  <div>
        <div class="description">
          Tidyverse R enthusiasts know about nesting grouped data into a column and iterating using purrr::map(), but did you know you could nest function source code? This post uses a data validation example to explain how I used this nest-and-iterate pattern over a set of validation tests while keeping the tests, their code, and their results in one Tidy tibble.
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">data science</div>
                <div class="quarto-category">functional programming</div>
                <div class="quarto-category">purrr</div>
                <div class="quarto-category">nested tibbles</div>
                <div class="quarto-category">R</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Aaron Politsky </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">February 11, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#intro" id="toc-intro" class="nav-link active" data-scroll-target="#intro">Intro</a></li>
  <li><a href="#the-example-data-validation-problem" id="toc-the-example-data-validation-problem" class="nav-link" data-scroll-target="#the-example-data-validation-problem">The Example Data Validation Problem</a>
  <ul class="collapse">
  <li><a href="#example-data" id="toc-example-data" class="nav-link" data-scroll-target="#example-data">Example Data</a></li>
  <li><a href="#the-field-test-catalog" id="toc-the-field-test-catalog" class="nav-link" data-scroll-target="#the-field-test-catalog">The Field-Test Catalog</a></li>
  <li><a href="#desired-output-form" id="toc-desired-output-form" class="nav-link" data-scroll-target="#desired-output-form">Desired Output Form</a></li>
  </ul></li>
  <li><a href="#nesting-the-function-code-into-a-tibble" id="toc-nesting-the-function-code-into-a-tibble" class="nav-link" data-scroll-target="#nesting-the-function-code-into-a-tibble">Nesting the Function Code into a Tibble</a></li>
  <li><a href="#the-real-trick-how-to-invoke-purrrmap" id="toc-the-real-trick-how-to-invoke-purrrmap" class="nav-link" data-scroll-target="#the-real-trick-how-to-invoke-purrrmap">The Real Trick: How to Invoke purrr::map()</a></li>
  <li><a href="#a-fine-but-less-tidy-method-using-lists" id="toc-a-fine-but-less-tidy-method-using-lists" class="nav-link" data-scroll-target="#a-fine-but-less-tidy-method-using-lists">A Fine but Less Tidy Method Using Lists</a></li>
  <li><a href="#closing-thoughts" id="toc-closing-thoughts" class="nav-link" data-scroll-target="#closing-thoughts">Closing Thoughts</a></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<section id="intro" class="level1">
<h1>Intro</h1>
<p>This post explains an insight I had when thinking about a data validation problem, and I hope this example problem will get you thinking more creatively about the possibilities of nested tibbles. (If you’re not familiar with the nested data workflow, read this <a href="https://tidyr.tidyverse.org/articles/nest.html">this concise article</a> first, and for more depth, read <a href="https://r4ds.had.co.nz/many-models.html">this chapter of R4DS</a>. I’ll wait.)</p>
<p>OK, Great. Now you’re at least somewhat familiar with the nested data workflow. That is, grouping your data and nesting each group’s data into cells in a column called “data”. You wind up with a Tidy, summarized tibble with one row per group so you can work with the nested data as a if it were a single value in a cell.</p>
<p>But did you ever think of nesting <em>source code</em> into a cell? If you’re at all curious about how or why this might be a good idea, keep reading.</p>
<p>My specific problem required running a bunch of data validation tests on a dataset, and I wanted to neatly keep track of the tests, their code, and their results. This reminded me of the nested data workflow, but instead of iterating over groups of <em>data</em>, I wanted to iterate over a group of validation functions. My insight was to nest each test’s <em>source code</em> into the tibble, execute each test on the data, and nest its results into another column, leaving me with a single, Tidy tibble having the test names, their code, and their results.</p>
<p>But why do it this way? Couldn’t you use base R using several separate lists and a vector of test names to access them? Sure, but I prefer having all this in one table. When everything is neatly tied together in rows it’s less error prone. Plus it’s Tidy, so it will be easy to work with later using the typical tidyverse methods.</p>
<p>Whereas using separate lists, it’s up to you to keep everything straight since the lists aren’t aware of one another. Someone (such as <em>future me</em>) could come along and accidentally rename the elements of one of the lists without updating the others, and it would fail quietly.</p>
<p>Let’s motivate this solution with an example problem.</p>
</section>
<section id="the-example-data-validation-problem" class="level1">
<h1>The Example Data Validation Problem</h1>
<p>In my case, I periodically received new data, and I wanted to validate them after arrival to get a sense of reliability and readiness. I needed to test certain fields to determine if their values made sense and were analytically useful. I would run a set of tests on each value in the dataset in order to:</p>
<ul>
<li><p>determine what subset of the data was OK to use right away,</p></li>
<li><p>judge whether the dataset as a whole was ok to use,</p></li>
<li><p>and decide whether I would need to contact the data provider to address any quality issues.</p></li>
</ul>
<p>Many tests would be sanity checks, whether a datapoint fell between a lower and upper bound, among others. Others could be more complex. And each field would require its own set of validation tests, sometimes fairly unique to that field.</p>
<section id="example-data" class="level2">
<h2 class="anchored" data-anchor-id="example-data">Example Data</h2>
<p>I’ll use <code>iris</code> as the example dataset. It’s got four decimal fields and one factor field per observation.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 150 × 6
   id    Sepal.Length Sepal.Width Petal.Length Petal.Width Species
   &lt;chr&gt;        &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;  
 1 1              5.1         3.5          1.4         0.2 setosa 
 2 2              4.9         3            1.4         0.2 setosa 
 3 3              4.7         3.2          1.3         0.2 setosa 
 4 4              4.6         3.1          1.5         0.2 setosa 
 5 5              5           3.6          1.4         0.2 setosa 
 6 6              5.4         3.9          1.7         0.4 setosa 
 7 7              4.6         3.4          1.4         0.3 setosa 
 8 8              5           3.4          1.5         0.2 setosa 
 9 9              4.4         2.9          1.4         0.2 setosa 
10 10             4.9         3.1          1.5         0.1 setosa 
# ℹ 140 more rows</code></pre>
</div>
</div>
</section>
<section id="the-field-test-catalog" class="level2">
<h2 class="anchored" data-anchor-id="the-field-test-catalog">The Field-Test Catalog</h2>
<p>As I thought about the problem, it became clear that I would want to define a set of validation tests for each field and keep track of the field-test catalog in a list or a table structure.</p>
<p>The catalog of field-tests might look something like this:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Field Name</th>
<th>Test Name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Sepal.Length</td>
<td>is_missing</td>
</tr>
<tr class="even">
<td>Sepal.Length</td>
<td>is_not_between_3_and_7</td>
</tr>
<tr class="odd">
<td>Sepal.Length</td>
<td>is_less_than_sepal_width</td>
</tr>
<tr class="even">
<td>…</td>
<td>…</td>
</tr>
<tr class="odd">
<td>Sepal.Width</td>
<td>is_missing</td>
</tr>
<tr class="even">
<td>Sepal.Width</td>
<td>…</td>
</tr>
<tr class="odd">
<td>…</td>
<td>…</td>
</tr>
<tr class="even">
<td>Petal.Length</td>
<td>is_missing</td>
</tr>
<tr class="odd">
<td>Petal.Length</td>
<td>is_not_between_4_and_7_when_species_is_virginica</td>
</tr>
<tr class="even">
<td>…</td>
<td></td>
</tr>
</tbody>
</table>
</section>
<section id="desired-output-form" class="level2">
<h2 class="anchored" data-anchor-id="desired-output-form">Desired Output Form</h2>
<p>I wanted to generate a set of results for each field-test that I could tie back to individual observations in the data. Results for one particular field’s test would look like this:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Id</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>FALSE</td>
</tr>
<tr class="even">
<td>2</td>
<td>FALSE</td>
</tr>
<tr class="odd">
<td>…</td>
<td>…</td>
</tr>
<tr class="even">
<td>149</td>
<td>TRUE</td>
</tr>
<tr class="odd">
<td>150</td>
<td>FALSE</td>
</tr>
</tbody>
</table>
<p>This is of course not very useful without knowing its corresponding field and test, so an expanded, flat set of results might look like this:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 18%">
<col style="width: 64%">
<col style="width: 6%">
<col style="width: 10%">
</colgroup>
<thead>
<tr class="header">
<th>Field</th>
<th>Test</th>
<th>Id</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Sepal.Length</td>
<td>is_missing</td>
<td>1</td>
<td>TRUE</td>
</tr>
<tr class="even">
<td>Sepal.Length</td>
<td>is_missing</td>
<td>2</td>
<td>FALSE</td>
</tr>
<tr class="odd">
<td>Sepal.Length</td>
<td>is_missing</td>
<td>…</td>
<td>…</td>
</tr>
<tr class="even">
<td>Sepal.Length</td>
<td>is_missing</td>
<td>138</td>
<td>TRUE</td>
</tr>
<tr class="odd">
<td>…</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>Petal.Width</td>
<td>is_not_between_4_and_7_when_species_is_virginica</td>
<td>32</td>
<td>NA</td>
</tr>
<tr class="odd">
<td>…</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>Petal.Width</td>
<td>is_not_between_4_and_7_when_species_is_virginica</td>
<td>138</td>
<td>FALSE</td>
</tr>
<tr class="odd">
<td>…</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>Species</td>
<td>is_not_within_known_set</td>
<td>1</td>
<td>TRUE</td>
</tr>
<tr class="odd">
<td>…</td>
<td>…</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>The objects I would need to keep track of included:</p>
<ol type="1">
<li><p>the field-test catalog</p></li>
<li><p>each field-test’s source code, parameters, and description</p></li>
<li><p>each field-test’s results</p></li>
<li><p>and the iris_tbl dataset itself</p></li>
</ol>
<p>This smelled like the nested data workflow, but inverted. Rather than mapping one function to a group of datasets, I would feed one dataset to a group of functions.</p>
</section>
</section>
<section id="nesting-the-function-code-into-a-tibble" class="level1">
<h1>Nesting the Function Code into a Tibble</h1>
<p>I made a hierarchical list for the field test functions, and then I converted it into a tibble like so:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>field_test_functions_list <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Sepal.Length"</span> <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"is_missing"</span> <span class="ot">=</span> <span class="cf">function</span>(data) {</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>      data <span class="sc">%&gt;%</span> </span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">result =</span> <span class="fu">is.na</span>(Sepal.Length)) <span class="sc">%&gt;%</span> </span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(id, result)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Sepal.Width"</span> <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"is_missing"</span> <span class="ot">=</span> <span class="cf">function</span>(data) {</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>      data <span class="sc">%&gt;%</span> </span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">result =</span> <span class="fu">is.na</span>(Sepal.Width)) <span class="sc">%&gt;%</span> </span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(id, result)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Petal.Length"</span> <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"is_missing"</span> <span class="ot">=</span> <span class="cf">function</span>(data) {</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>      data <span class="sc">%&gt;%</span> </span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">result =</span> <span class="fu">is.na</span>(Petal.Width)) <span class="sc">%&gt;%</span> </span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(id, result)</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"is_not_between_4_and_7_when_species_is_virginica"</span> <span class="ot">=</span> <span class="cf">function</span>(data) {</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>      data <span class="sc">%&gt;%</span> </span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">result =</span> <span class="fu">if_else</span>(Species <span class="sc">==</span> <span class="st">"virginica"</span>,  </span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>                                <span class="sc">!</span><span class="fu">between</span>(Petal.Length, <span class="dv">4</span>, <span class="dv">7</span>),</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>                                <span class="cn">NA</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(id, result)</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Species"</span> <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>    <span class="st">"is_not_within_known_set"</span> <span class="ot">=</span> <span class="cf">function</span>(data) {</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>      data <span class="sc">%&gt;%</span> </span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">result =</span> </span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>                 <span class="sc">!</span>(Species <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"setosa"</span>, <span class="st">"versicolor"</span>, <span class="st">"virginica"</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(id, result)</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now let’s convert that to a tibble, in steps.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lapply</span>(field_test_functions_list, enframe, <span class="at">name =</span> <span class="st">"test"</span>, <span class="at">value =</span> <span class="st">"fun"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$Sepal.Length
# A tibble: 1 × 2
  test       fun   
  &lt;chr&gt;      &lt;list&gt;
1 is_missing &lt;fn&gt;  

$Sepal.Width
# A tibble: 1 × 2
  test       fun   
  &lt;chr&gt;      &lt;list&gt;
1 is_missing &lt;fn&gt;  

$Petal.Length
# A tibble: 2 × 2
  test                                             fun   
  &lt;chr&gt;                                            &lt;list&gt;
1 is_missing                                       &lt;fn&gt;  
2 is_not_between_4_and_7_when_species_is_virginica &lt;fn&gt;  

$Species
# A tibble: 1 × 2
  test                    fun   
  &lt;chr&gt;                   &lt;list&gt;
1 is_not_within_known_set &lt;fn&gt;  </code></pre>
</div>
</div>
<p>Now let’s make that into a tibble using <code>enframe()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lapply</span>(field_test_functions_list, enframe, <span class="at">name =</span> <span class="st">"test"</span>, <span class="at">value =</span> <span class="st">"fun"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">enframe</span>(<span class="at">name =</span> <span class="st">"field"</span>, <span class="at">value =</span> <span class="st">"test_tibble"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 2
  field        test_tibble     
  &lt;chr&gt;        &lt;list&gt;          
1 Sepal.Length &lt;tibble [1 × 2]&gt;
2 Sepal.Width  &lt;tibble [1 × 2]&gt;
3 Petal.Length &lt;tibble [2 × 2]&gt;
4 Species      &lt;tibble [1 × 2]&gt;</code></pre>
</div>
</div>
<p>And one more step: <code>unnest()</code> the test_tibbles:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>field_test_tibble <span class="ot">&lt;-</span> </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(field_test_functions_list, enframe, <span class="at">name =</span> <span class="st">"test"</span>, <span class="at">value =</span> <span class="st">"fun"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">enframe</span>(<span class="at">name =</span> <span class="st">"field"</span>, <span class="at">value =</span> <span class="st">"test_tibble"</span>) <span class="sc">%&gt;%</span>  </span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(test_tibble)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>field_test_tibble</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 3
  field        test                                             fun   
  &lt;chr&gt;        &lt;chr&gt;                                            &lt;list&gt;
1 Sepal.Length is_missing                                       &lt;fn&gt;  
2 Sepal.Width  is_missing                                       &lt;fn&gt;  
3 Petal.Length is_missing                                       &lt;fn&gt;  
4 Petal.Length is_not_between_4_and_7_when_species_is_virginica &lt;fn&gt;  
5 Species      is_not_within_known_set                          &lt;fn&gt;  </code></pre>
</div>
</div>
<p>Now we have our Tidy field-tests tibble, and we’re ready to iterate using <code>purrr::map</code>.</p>
</section>
<section id="the-real-trick-how-to-invoke-purrrmap" class="level1">
<h1>The Real Trick: How to Invoke purrr::map()</h1>
<p>We are iterating over test functions we’ve named <code>fun</code>, and we want to <em>execute</em> each of them. This is the really meta part: we want to <code>map()</code> the function <code>exec()</code> onto each <code>fun</code>.</p>
<p>In <code>purrr::map</code> syntax, we normally would map a function <code>.f</code> to data <code>.x</code> like this:</p>
<p><code>map(.x = data, .f = fun)</code></p>
<p>But instead we need to do this: <code>map(.x = fun, .f = exec)</code></p>
<p>And since each <code>fun</code> expects the argument <code>data</code>, we pass it as a third argument:</p>
<p><code>map(.x = fun, .f = exec, data = iris_tbl)</code></p>
<p>This will produce our result tibble for each field test, so we can do that all within <code>mutate</code> like so:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>field_tests_with_results <span class="ot">&lt;-</span> </span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  field_test_tibble <span class="sc">%&gt;%</span> </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">results =</span> <span class="fu">map</span>(<span class="at">.x =</span> fun, <span class="at">.f =</span> exec, <span class="at">data =</span> iris_tbl))</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>field_tests_with_results </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 4
  field        test                                             fun    results 
  &lt;chr&gt;        &lt;chr&gt;                                            &lt;list&gt; &lt;list&gt;  
1 Sepal.Length is_missing                                       &lt;fn&gt;   &lt;tibble&gt;
2 Sepal.Width  is_missing                                       &lt;fn&gt;   &lt;tibble&gt;
3 Petal.Length is_missing                                       &lt;fn&gt;   &lt;tibble&gt;
4 Petal.Length is_not_between_4_and_7_when_species_is_virginica &lt;fn&gt;   &lt;tibble&gt;
5 Species      is_not_within_known_set                          &lt;fn&gt;   &lt;tibble&gt;</code></pre>
</div>
</div>
<p>As you can see, Each field-test’s field name, test name, code, and results are all tied together in a row.</p>
<p>And of course, we can then unnest our results into our desired tabular output:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>field_tests_with_results <span class="sc">%&gt;%</span> </span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(field, test, results) <span class="sc">%&gt;%</span> </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 750 × 4
   field        test       id    result
   &lt;chr&gt;        &lt;chr&gt;      &lt;chr&gt; &lt;lgl&gt; 
 1 Sepal.Length is_missing 1     FALSE 
 2 Sepal.Length is_missing 2     FALSE 
 3 Sepal.Length is_missing 3     FALSE 
 4 Sepal.Length is_missing 4     FALSE 
 5 Sepal.Length is_missing 5     FALSE 
 6 Sepal.Length is_missing 6     FALSE 
 7 Sepal.Length is_missing 7     FALSE 
 8 Sepal.Length is_missing 8     FALSE 
 9 Sepal.Length is_missing 9     FALSE 
10 Sepal.Length is_missing 10    FALSE 
# ℹ 740 more rows</code></pre>
</div>
</div>
<p><em>Note: since <code>data</code> is a constant, it doesn’t need to live in our tibble, which would be duplicative and likely make our tibble enormous.</em></p>
<p>But why do it this way? Couldn’t I just do this using vectors and lists?</p>
</section>
<section id="a-fine-but-less-tidy-method-using-lists" class="level1">
<h1>A Fine but Less Tidy Method Using Lists</h1>
<p>One way I might have done this before knowing about nested tibbles is to iterate over the field test list to create a separate, hierarchical results list.</p>
<p>This is…fine. But if you’re used to working with Tidy tibbles and dplyr-like verbs you might find it unsatisfying.</p>
<p>Furthermore, if you care about future-proofing it for other users (including your future self), it might bother you that the field test code will be in one object and its results in another, since they aren’t aware of each other and it’s up to the developer to make sure the names stay correct. Mistakes happen!</p>
<p>In any case, here’s how I would do it. Given the <code>field_test_functions_list</code> I created above, I would iterate over our fields using <code>lapply</code>, and within that, iterate over each of its tests using another <code>lapply</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># iterate over field names, and test names within them, executing test functions on iris</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>field_test_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="at">X =</span> field_test_functions_list, </span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>                             <span class="co"># for each field fn, which is a list of tests...</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>                             <span class="at">FUN =</span> <span class="cf">function</span>(tests) {</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>                               <span class="co"># execute each test, each of which are functions</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>                               <span class="fu">lapply</span>(<span class="at">X =</span> tests, </span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">FUN =</span> <span class="cf">function</span>(test) {</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>                                        <span class="fu">exec</span>(test, <span class="at">data =</span> iris_tbl)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>                                      })</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>                             })</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(field_test_results) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 4
 $ Sepal.Length:List of 1
  ..$ is_missing: tibble [150 × 2] (S3: tbl_df/tbl/data.frame)
  .. ..$ id    : chr [1:150] "1" "2" "3" "4" ...
  .. ..$ result: logi [1:150] FALSE FALSE FALSE FALSE FALSE FALSE ...
 $ Sepal.Width :List of 1
  ..$ is_missing: tibble [150 × 2] (S3: tbl_df/tbl/data.frame)
  .. ..$ id    : chr [1:150] "1" "2" "3" "4" ...
  .. ..$ result: logi [1:150] FALSE FALSE FALSE FALSE FALSE FALSE ...
 $ Petal.Length:List of 2
  ..$ is_missing                                      : tibble [150 × 2] (S3: tbl_df/tbl/data.frame)
  .. ..$ id    : chr [1:150] "1" "2" "3" "4" ...
  .. ..$ result: logi [1:150] FALSE FALSE FALSE FALSE FALSE FALSE ...
  ..$ is_not_between_4_and_7_when_species_is_virginica: tibble [150 × 2] (S3: tbl_df/tbl/data.frame)
  .. ..$ id    : chr [1:150] "1" "2" "3" "4" ...
  .. ..$ result: logi [1:150] NA NA NA NA NA NA ...
 $ Species     :List of 1
  ..$ is_not_within_known_set: tibble [150 × 2] (S3: tbl_df/tbl/data.frame)
  .. ..$ id    : chr [1:150] "1" "2" "3" "4" ...
  .. ..$ result: logi [1:150] FALSE FALSE FALSE FALSE FALSE FALSE ...</code></pre>
</div>
</div>
<p>Now if we want to examine a given field test and its results, we would need to select it with a field name and a test name.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>fields <span class="ot">&lt;-</span> <span class="fu">names</span>(field_test_functions_list)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>tests <span class="ot">&lt;-</span> <span class="fu">names</span>(field_test_functions_list[[fields[<span class="dv">2</span>]]])</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>field_test_functions_list[[fields[<span class="dv">2</span>]]][[tests[<span class="dv">1</span>]]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>function(data) {
      data %&gt;% 
        mutate(result = is.na(Sepal.Width)) %&gt;% 
        select(id, result)
    }
&lt;bytecode: 0x1381a4318&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>field_test_results[[fields[<span class="dv">2</span>]]][[tests[<span class="dv">1</span>]]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 150 × 2
   id    result
   &lt;chr&gt; &lt;lgl&gt; 
 1 1     FALSE 
 2 2     FALSE 
 3 3     FALSE 
 4 4     FALSE 
 5 5     FALSE 
 6 6     FALSE 
 7 7     FALSE 
 8 8     FALSE 
 9 9     FALSE 
10 10    FALSE 
# ℹ 140 more rows</code></pre>
</div>
</div>
<p>Again, this is fine, but it feels more precarious as a developer. Perhaps you might alleviate some of that fragility by storing the results and the functions in the same list. That would probably be an improvement. But still, a hierarchical list still doesn’t lend itself to using tidyverse verbs, which is partially why I prefer my solution.</p>
</section>
<section id="closing-thoughts" class="level1">
<h1>Closing Thoughts</h1>
<p>If you’re familiar with the paradigm of iterating over nested data, hopefully this gets you thinking about extending that pattern. After all, you can nest anything into a cell.</p>
<p>For my data validation problem, I could have used a set of lists and <code>lapply</code>, but I find it more fragile and prefer playing well with the tidyverse, which likes tabular data. So I targeted building a single, Tidy tibble with columns for field, test name, each datapoint’s id, and test result. The twist was to nest source code into a cell and using <code>purrr::map</code> to execute each test.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/aaronpolitsky\.github\.io\/portfolio_blog\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">

<div class="cookie-consent-footer"><a href="#" id="open_preferences_center">Cookie Preferences</a></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>